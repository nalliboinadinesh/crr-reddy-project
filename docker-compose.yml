version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: polytechnic-mongodb
    restart: unless-stopped
    ports:
      - " 27017:27017\
 environment:
 MONGO_INITDB_ROOT_USERNAME: \
 MONGO_INITDB_ROOT_PASSWORD: \
 MONGO_INITDB_DATABASE: \
 volumes:
 - mongodb_data:/data/db
 - mongodb_config:/data/configdb
 networks:
 - polytechnic-network
 healthcheck:
 test: echo 'db.runCommand(\ping\).ok' | mongosh localhost:27017/test --quiet
 interval: 10s
 timeout: 5s
 retries: 5

 # Backend API Server
 backend:
 build:
 context: ./backend
 dockerfile: Dockerfile
 container_name: polytechnic-backend
 restart: unless-stopped
 ports:
 - \5000:5000\
 environment:
 MONGODB_URI: \
 PORT: 5000
 NODE_ENV: \
 JWT_SECRET: \
 JWT_REFRESH_SECRET: \
 JWT_EXPIRE: \
 JWT_REFRESH_EXPIRE: \
 AWS_ACCESS_KEY_ID: \
 AWS_SECRET_ACCESS_KEY: \
 AWS_BUCKET_NAME: \
 AWS_REGION: \
 CORS_ORIGIN: \
 LOG_LEVEL: \
 depends_on:
 mongodb:
 condition: service_healthy
 volumes:
 - ./backend/logs:/app/logs
 networks:
 - polytechnic-network
 healthcheck:
 test: [\CMD\, \curl\, \-f\, \http://localhost:5000/api/health\]
 interval: 30s
 timeout: 10s
 retries: 3
 start_period: 20s

 # User Application Frontend
 user-app:
 build:
 context: ./user-app
 dockerfile: Dockerfile
 args:
 REACT_APP_API_URL: http://backend:5000/api
 container_name: polytechnic-user-app
 restart: unless-stopped
 ports:
 - \3000:3000\
 depends_on:
 backend:
 condition: service_healthy
 networks:
 - polytechnic-network
 healthcheck:
 test: [\CMD\, \wget\, \--quiet\, \--tries=1\, \--spider\, \http://localhost:3000\]
 interval: 30s
 timeout: 10s
 retries: 3
 start_period: 20s

 # Admin Application Frontend
 admin-app:
 build:
 context: ./admin-app
 dockerfile: Dockerfile
 args:
 REACT_APP_API_URL: http://backend:5000/api
 container_name: polytechnic-admin-app
 restart: unless-stopped
 ports:
 - \3001:3001\
 depends_on:
 backend:
 condition: service_healthy
 networks:
 - polytechnic-network
 healthcheck:
 test: [\CMD\, \wget\, \--quiet\, \--tries=1\, \--spider\, \http://localhost:3001\]
 interval: 30s
 timeout: 10s
 retries: 3
 start_period: 20s

volumes:
 mongodb_data:
 driver: local
 mongodb_config:
 driver: local

networks:
 polytechnic-network:
 driver: bridge
